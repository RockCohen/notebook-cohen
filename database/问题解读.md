# 1 磁盘操作粒度的影响.
**问题描述:**

- **除了磁盘访问本身的成本之外，磁盘操作的最小单元是块这一事实是构建有效的磁盘存储结构的主要限制和设计条件**

**问题分析:**

磁盘的物理特性决定了其读写操作的最小单位是"块"（block），通常为4KB、8KB等。即使只需要读取或写入一个字节的数据，磁盘也必须以块为单位进行操作。

这一事实对磁盘存储结构的设计产生了深远影响，主要体现在以下几个方面：

## 1.1 块的最小操作单元限制
- **空间利用率**：如果数据项远小于块大小，直接存储会造成空间浪费。例如，存储大量小文件时，每个文件至少占用一个块，导致磁盘碎片和空间浪费。
- **I/O效率**：批量读写块可以提升I/O效率，但也可能导致不必要的数据被加载到内存中。

## 1.2 设计磁盘存储结构的实际例子
### 例子1：文件系统的块分配
以Ext4文件系统为例，所有文件都以块为单位分配空间。即使一个文件只有1字节，也会占用一个完整的块（如4KB）。

这就是为什么存储大量小文件时，磁盘空间利用率会降低。

```
+-------------------+-------------------+-------------------+
|      Block 1      |      Block 2      |      Block 3      |
+-------------------+-------------------+-------------------+
| 文件A(1KB)        | 文件B(2KB)        | 文件C(1B)           |
| 剩余空间(3KB)      | 剩余空间(2KB)      | 剩余空间(4095B)     |
+-------------------+-------------------+-------------------+
```
**说明**：每个文件最小占用一个块，即使文件很小也会造成空间浪费。

### 例子2：数据库的页（Page）管理
- 便于批量读写，提高I/O效率。
- 支持高效的缓存和缓冲区管理。
- 便于实现B+树等索引结构，每个节点对应一个或多个页。

```
+-------------------+-------------------+-------------------+
|    Page 1 (8KB)   |    Page 2 (8KB)   |    Page 3 (8KB)   |
+-------------------+-------------------+-------------------+
| Block 1 | Block 2 | Block 3 | Block 4 | Block 5 | Block 6 |
+---------+---------+---------+---------+---------+---------+
```
**说明**：数据库通常以页为单位管理数据，每页由若干个磁盘块组成，便于批量I/O和缓存管理。

### 例子3：B+树索引结构
B+树广泛用于数据库和文件系统索引。其每个节点的大小通常设计为与磁盘块或页大小一致，这样每次磁盘I/O都能完整地读写一个节点，最大化I/O效率。

```
        [B+树根节点]
              |
    +---------+---------+
    |                   |
[节点1(=1块)]     [节点2(=1块)]
    |                   |
[叶子节点(=1块)]  [叶子节点(=1块)]
```
**说明**：B+树的每个节点大小设计为与磁盘块一致，保证每次I/O都能完整读写一个节点，提高效率。

## 1.3 设计启示
- 存储结构应尽量使数据的逻辑单元与物理块对齐，减少I/O次数。
- 对于大量小数据项，可以采用块内多项存储、压缩等方式提升空间利用率。
- 索引结构应考虑块大小，优化节点分布以减少磁盘访问次数。

综上，磁盘以块为最小操作单元不仅影响了存储空间的利用，还直接决定了存储结构的设计方式，是数据库和文件系统等高效运行的基础。

# 2 磁盘存储结构设计优化：减少磁盘访问的策略

**问题描述：**

- 磁盘存储结构的设计要充分考虑目标存储介质的特性，并且通常要为实现更少的磁盘访问进行优化。我们可以通过提高局部性、优化结构的内部表示以及减少页外指针的数量来实现这一点。

## 2.1 提高局部性

局部性分为**时间局部性**和**空间局部性**。通过将相关数据尽量存储在相邻的块或页中，可以减少磁盘寻道和I/O次数。

**图示：**

```
+---------+---------+---------+---------+
|  页1    |  页2    |  页3    |  页4    |
+---------+---------+---------+---------+
|数据A,B  |数据C,D  |数据E,F  |数据G,H  |
+---------+---------+---------+---------+
```

**说明**：将经常一起访问的数据（如A、B）存储在同一页或相邻页中，提升空间局部性，减少磁盘访问。

## 2.2 优化结构的内部表示

合理设计数据结构的内部布局，使其更好地适应磁盘块/页的大小。例如，B+树节点大小与页对齐，哈希桶分布均匀，减少溢出页。

**图示：**

```
        [B+树根节点(1页)]
               |
      +--------+--------+
      |                 |
[节点1(1页)]      [节点2(1页)]
      |                 |
[叶1(1页)]        [叶2(1页)]
```

**说明**：每个节点与页对齐，保证每次I/O都能完整读写一个节点，提升效率。

## 2.3 减少页外指针数量

页外指针（如溢出页、间接寻址）会导致一次逻辑访问需要多次磁盘I/O。通过优化分配策略、合并小数据项等方式，可以减少页外指针数量。

**图示：**

```
+---------+---------+---------+
|  页1    |  页2    |  页3    |
+---------+---------+---------+
|数据A,B  |数据C,D  |溢出页→ |
+---------+---------+---------+
```

**说明**：减少溢出页（页外指针），可降低访问链路长度，减少I/O次数。

## 2.4 设计总结
- 提高局部性：相关数据物理上靠近，减少I/O。
- 内部表示优化：结构与块/页对齐，提升批量I/O效率。
- 减少页外指针：优化分配和布局，降低访问链路长度。

通过上述策略，磁盘存储结构能够更高效地利用磁盘特性，显著减少磁盘访问次数，提升整体系统性能。

# 3 B树查找复杂度分析

B树作为数据库和文件系统常用的索引结构，其查找复杂度可以从两个角度分析：

## 3.1 块传输次数（磁盘I/O次数）

B树的每个节点通常设计为与磁盘块或页大小一致。假设每个节点最多有N个键（即阶为N+1），每个节点的子节点数为N+1。

- **每次查找从根节点出发，逐层向下，直到叶子节点。**
- 每往下走一层，节点个数增加N倍，搜索空间缩小为原来的1/N。
- 因此，树的高度h约为：

  $$
  h = \log_N M
  $$
  其中M为B树中总的数据项数。
- 查找一个键时，最多需要访问h个节点（即h次磁盘I/O），也就是最多传输 $\log_N M$ 个块。

**图示：**

```
        [根节点]
         /  |  \
      /    |    \
 [子节点1][子节点2][子节点3] ...
      |        ...        |
   [叶节点1] ...      [叶节点N]
```

每访问一层节点就需要一次块传输，直到叶子节点。

## 3.2 比较次数（CPU内二分查找）

- 在每个节点内部，查找具体的键通常采用二分查找。
- 每个节点有N个键，二分查找的复杂度为 $\log_2 N$。
- 整个查找过程中，最多需要比较 $h \times \log_2 N$ 次。
- 由于M远大于N，整体复杂度近似为 $\log_2 M$。

**图示：**

```
[节点内容: 10 | 20 | 30 | 40 | 50]
   ↑   ↑   ↑   ↑   ↑
二分查找定位目标键
```

## 3.3 总结

- **块传输次数**：约为 $\log_N M$，即树的高度。
- **比较次数**：约为 $\log_2 M$，即节点内二分查找的总次数。

B树通过增大节点（块）内的键数N，显著降低了树的高度，从而减少了磁盘I/O次数，是高效的外存索引结构。

